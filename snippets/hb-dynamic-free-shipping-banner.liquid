{%- comment -%}
HANA BEAUTY • Banner Dinâmico de Frete Grátis por Região/Estado
- Ambiente: hana-tema-base/main (tema de testes)
- Regras oficiais:
  SP:  R$ 99,00
  Sudeste (RJ, MG, ES): R$ 199,00
  Sul (RS, SC, PR): R$ 259,00
  Centro-Oeste (GO, MT, MS, DF): R$ 459,00
  Norte/Nordeste (demais UFs listadas): R$ 529,00
- Sem cálculo de frete por CEP na PDP; frete é confirmado no checkout.
{%- endcomment -%}

{%- assign v = product.selected_or_first_available_variant -%}

<div id="hana-frete" class="hana-frete" role="status" aria-live="polite">
  <div class="hana-frete__badge">Frete</div>

  <p class="hana-frete__headline">
    Frete grátis para
    <strong><span id="hana-frete-region">sua região</span></strong>
    em pedidos a partir de
    <strong><span id="hana-frete-min">—</span></strong>.
  </p>

  <p class="hana-frete__status" id="hana-frete-status" hidden></p>

  <p class="hana-frete__helper">
    O valor e o prazo exatos são calculados automaticamente no checkout,
    após você informar seu endereço.
  </p>
</div>

<script>
(function(){
  // ==== Helpers ====
  const moneyBR = v =>
    new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v / 100);

  const productPriceCents = {{ v.price | default: 0 | json }};

  // Mínimos por estado/região (centavos)
  const STATE_THRESHOLDS = {
    "SP": 9900 // São Paulo
  };

  const REGION_THRESHOLDS = {
    "Sudeste": 19900,
    "Sul": 25900,
    "Centro-Oeste": 45900,
    "Norte/Nordeste": 52900
  };

  const sudeste = ['SP','RJ','MG','ES'];
  const sul = ['RS','SC','PR'];
  const centro = ['GO','MT','MS','DF'];
  const norteNordeste = ['AC','AP','AM','PA','RO','RR','TO','AL','BA','CE','MA','PB','PE','PI','RN','SE'];

  const $region = document.getElementById('hana-frete-region');
  const $min    = document.getElementById('hana-frete-min');
  const $status = document.getElementById('hana-frete-status');
  const $root   = document.getElementById('hana-frete');

  if (!$root || !$region || !$min || !$status) return;

  function getCartTotal(){
    return fetch('/cart.js', { credentials: 'same-origin' })
      .then(r => r.ok ? r.json() : { total_price: 0 })
      .then(cart => cart.total_price || 0)
      .catch(() => 0);
  }

  function detectUFAndRegion(){
    return fetch('https://ipapi.co/json/')
      .then(r => r.json())
      .then(d => {
        const uf = String(d.region_code || '').toUpperCase();
        let region = 'Sudeste';
        if (sudeste.includes(uf)) region = 'Sudeste';
        else if (sul.includes(uf)) region = 'Sul';
        else if (centro.includes(uf)) region = 'Centro-Oeste';
        else if (norteNordeste.includes(uf)) region = 'Norte/Nordeste';
        return { uf, region };
      })
      .catch(() => ({ uf: 'SP', region: 'Sudeste' })); // fallback plausível
  }

  function updateUI(labelRegion, minCents, qualifies, diffCents){
    $region.textContent = labelRegion;
    $min.textContent = moneyBR(minCents);

    if (qualifies){
      $status.hidden = false;
      $status.className = 'hana-frete__status ok';
      $status.textContent = 'Seu pedido já garante frete grátis para essa região.';
    } else {
      $status.hidden = false;
      $status.className = 'hana-frete__status warn';
      $status.textContent = 'Faltam ' + moneyBR(diffCents) + ' para você garantir frete grátis.';
    }
  }

  Promise.all([detectUFAndRegion(), getCartTotal()]).then(([geo, cartTotal]) => {
    const uf = geo.uf;
    const region = geo.region;

    let labelRegion = region;
    let minCents;

    if (STATE_THRESHOLDS[uf]) {
      labelRegion = 'São Paulo';
      minCents = STATE_THRESHOLDS[uf];
    } else {
      minCents = REGION_THRESHOLDS[region] || REGION_THRESHOLDS['Sudeste'];
    }

    const basis = (cartTotal && cartTotal > 0) ? cartTotal : (productPriceCents || 0);
    const qualifies = basis >= minCents;
    const diff = qualifies ? 0 : Math.max(minCents - basis, 0);

    updateUI(labelRegion, minCents, qualifies, diff);
  });
})();
</script>

<style>
/* ===== Banner de Frete Hana Beauty – Premium Black November (sem ícone) ===== */
.hana-frete{
  border:1px solid #e4e4e7;
  background:#f9fafb;
  border-radius:16px;
  padding:16px 16px 12px;
  box-shadow:0 2px 10px rgba(0,0,0,.04);
  color:#111827;
  font-size:0.97rem;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

.hana-frete__badge{
  display:inline-block;
  background:#fdf2f8;
  color:#be185d;
  border:1px solid #f9a8d4;
  padding:3px 10px;
  border-radius:9999px;
  font-weight:700;
  font-size:12px;
  letter-spacing:.02em;
  margin-bottom:6px;
}

/* Headline: informação principal do card */
.hana-frete__headline{
  margin:0;
  font-size:1.06rem;
  line-height:1.45;
  font-weight:600;
  color:#111827;
}

/* Status: já tem ou não frete grátis */
.hana-frete__status{
  margin-top:6px;
  margin-bottom:0;
  font-size:0.98rem;
  font-weight:600;
}

.hana-frete__status.ok{
  color:#166534;
  background:#dcfce7;
  border:1px solid #86efac;
  padding:4px 10px;
  border-radius:999px;
  width:max-content;
}

.hana-frete__status.warn{
  color:#854d0e;
  background:#fef3c7;
  border:1px solid #facc15;
  padding:4px 10px;
  border-radius:999px;
  width:max-content;
}

/* Linha auxiliar */
.hana-frete__helper{
  margin-top:6px;
  font-size:0.9rem;
  color:#4b5563;
}

/* MOBILE: foco total em leitura */
@media (max-width: 640px){
  .hana-frete{
    padding:14px 14px 12px;
    border-radius:14px;
    font-size:1rem;
  }

  .hana-frete__headline{
    font-size:1.12rem;   /* ~18px */
  }

  .hana-frete__status{
    font-size:1.02rem;   /* ~16,5–17px */
  }

  .hana-frete__helper{
    font-size:0.92rem;
  }
}

/* ===== Versão Premium Black November (tema escuro com .bn-theme no body) ===== */
.bn-theme .hana-frete{
  background:#020617;
  border-color:#27272a;
  box-shadow:0 2px 16px rgba(0,0,0,.65);
  color:#f9fafb;
}

.bn-theme .hana-frete__badge{
  background:rgba(239,68,111,0.12);
  color:#fecaca;
  border-color:rgba(248,113,113,0.45);
}

.bn-theme .hana-frete__status.ok{
  color:#bbf7d0;
  background:rgba(22,163,74,0.30);
  border-color:rgba(74,222,128,0.50);
}

.bn-theme .hana-frete__status.warn{
  color:#fde68a;
  background:rgba(245,158,11,0.28);
  border-color:rgba(251,191,36,0.55);
}

.bn-theme .hana-frete__helper{
  color:#9ca3af;
}
</style>
